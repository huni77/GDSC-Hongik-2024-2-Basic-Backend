# 서비스 계층

• 어플리케이션의 `비즈니스 로직` 이 담기는 계층

- 비즈니스 로직: 서비스 운용하는데 필요한 규칙? 같은 것
  • 레포지토리 계층과 소통하며 엔티티, 또는 DTO로 소통한다.

## <비즈니스 로직 예시>

• 할 일을 생성한다.
• 할 일은 인당 최대 10개까지 생성할 수 있다. (예시, 실제로 구현 x)
• 할 일을 수정한다.
• 할 일은 그 일을 생성한 유저만 삭제할 수 있다.

## 비즈니스 로직 예시 - 예산 부족으로 DB 용량 제한이 생겼을 때

• 할 일은 인당 최대 10개까지 생성할 수 있다.

1.  할 일을 생성하려는 유저를 조회한다.
2.  해당 유저가 생성한 모든 할 일을 조회한다.
3.  모든 할 일의 개수가 10개보다 적은 지 확인한다.
4.  10개보다 적다면, 할 일을 생성한다.

## 비즈니스 로직 예시 - 에러 발생 시

• 만약 중간에 에러가 발생한다면?

1.  할 일을 생성하려는 유저를 조회한다.
2.  해당 유저가 생성한 모든 할 일을 조회한다.
3.  모든 할 일의 개수가 10개보다 적은 지 확인한다.
4.  10개보다 적다면, 할 일을 생성한다.

등등 다양한 비즈니스 로직이 존재할 수 있다.

## 서비스 계층: 원자성

• 서비스 계층의 하나의 메서드에는 원자성을 갖는 로직(쪼갤 수 없는 로직) 을 기술한다.
• 로직의 원자성을 보장하기 위해서 서비스 계층에 메서드 단위로 트랜잭션을 적용해준다.

## 서비스 계층 구현하기

• todo 패키지에 TodoService 클래스 추가
• 서비스도 객체를 중복해서 생성할 필요가 없기 때문에 @Service 어노테이션을 이용하여 빈으로 등록해서 사용한다.

- @Service 어노테이션 안에 @Component 어노테이션이 포함되어 있기 때문에 자동으로 컴포넌트 스캔 방식으로 빈으로 등록해줌
  • 서비스 계층은 레포지토리 계층에 의존한다. 생성자 주입방식(@RequiredArgsConstructor)으로 의존성을 주입받자.

## 할 일 생성 비즈니스 로직 작성해보기

• TodoRepository의 save() 기능을 이용하여 할 일 생성 비즈니스 로직을 작성.
• 레포지토리 계층을 사용하는 서비스 로직은 반드시 트랜잭션(@Transactional) 안에서 동작하도록 작성한다.
• 메서드에 @Transactional 을 붙여준다.
• content, user는 클라이언트가 제공하는 정보이므로 컨트롤러로부터 받아서 저장하도록 수정한다.
• 이때 user는 user_id만 받은 뒤 DB에서 id를 가지고 user를 조회해서 저장하자.
• isChecked 속성은 todo 객체를 생성할 때 false가 기본값이다.
• 생성자에서 isChecked 매개변수를 제거하고, 기본값을 지정하자.
• isChecked 속성은 todo 객체를 생성할 때 false가 기본값이다.
• 생성자에서 isChecked 매개변수를 제거하고, 기본값을 지정하자.

### 할 일 생성 –예외 처리

• 만약 user_id 값이 존재하지 않으면, findById()의 반환 값은 null
• 로그인한 유저만 할 일을 생성할 수 있도록, user 값이 null 이라면 예외를 발생시킨다.

## 서비스 테스트

• 할 일 생성 로직이 잘 동작하는지 확인하기 위해 테스트 코드를 작성하자.
• 서비스 테스트는 단위 테스트로작성해보자.
• 단위 테스트는 스프링 부트와 다른 클래스에 의존하지 않고, 대상 자바 클래스 하나만 단독으로 테스트하는 것을 말한다.
• 서비스 클래스를 단독으로 테스트하기 위해, 서비스가 의존하는 레포지토리는 가짜 객체를 사용한다.
• 이 가짜 객체를 가리켜 mock이라고 한다.
• 실제 객체를 흉내내는 mock을 만드는 행위를 mocking 이라고 한다.
• Mocking을 쉽게 도와주는 Mockito 라이브러리를 사용해 단위 테스트를 작성해보자.

### Mockito 사용

• @ExtendWith 어노테이션을 사용하여 테스트 클래스에 Mockito를 적용한다.
• @Mock을 사용하여 주입할 객체를 모킹한다.
• @InjectMocks를 사용하여, 서비스 객체를 생성할 때모킹한 객체를 주입한다.
• given() 메서드로 mock 객체의 특정 메서드를 호출했을 때 그 반환값을 임의로 지정할 수 있다.
• verify() 메서드로 mock 객체의 특정 메서드를 몇 번 호출했는지 검증할 수 있다.

• 할 일 생성에 성공하면, todoRepository의 save() 메서드가 1번 호출된다.

## 예외 테스트

• 존재하지 않는 유저라면 에러가 발생해야 한다.
• 로그인한 유저의 모든 할 일을 조회하는 로직을 작성한다.
조회만 하는 경우, 트랜잭션 내에서 데이터가 변경되지 않도록 `readOnly` 속성을 활성화한다.

## 할 일 수정 비즈니스 로직 작성해보기

• 할 일을 수정하는 로직을 작성한다.
• 엄밀하게 명세를 구현한다면, 조회한 todo가 현재 로그인한 유저의 todo인지 검증해야 한다.

## 할 일 삭제 비즈니스 로직 작성해보기

• 할 일을 삭제하는 로직을 작성한다.
• 엄밀하게 명세를 구현한다면, 삭제하려는 todo가 현재 로그인한 유저의 todo인지 검증해야 한다.
